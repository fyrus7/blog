<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel (Markdown)</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; padding: 20px; }
    input, textarea, button { width: 100%; margin: 8px 0; padding: 8px; border-radius: 6px; border: none; }
    input, textarea { background: #222; color: #fff; }
    button { background: #0a84ff; color: white; cursor: pointer; }
    button:hover { opacity: .9; }
    .file-list { margin-top: 20px; }
    .file-item { background: #222; padding: 10px; border-radius: 6px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
    .file-item button { width: auto; margin-left: 10px; background: #ff453a; }
    .guide {
      background: #1c1c1e; 
      padding: 10px; 
      border-radius: 8px; 
      margin-top: 8px;
      font-size: 14px;
      line-height: 1.6;
    }
    .guide code {
      background: #333; 
      padding: 2px 6px; 
      border-radius: 4px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <h1>üõ† Admin Panel (Markdown Mode)</h1>

  <label>üîë GitHub Personal Access Token (PAT):</label>
  <input type="password" id="token" placeholder="Masukkan Token...">

  <label>üìÑ Nama Post (contoh: post1.html):</label>
  <input type="text" id="filename" placeholder="post1.html">

  <label>üìù Kandungan Post (Markdown Style):</label>
  <textarea id="content" rows="12" placeholder="# Tajuk Post&#10;Tulis blog post di sini..."></textarea>

  <div class="guide">
    <strong>Panduan Format:</strong><br>
    üè∑Ô∏è Tajuk: <code># Tajuk Post</code><br>
    üß± Perenggan: <code>Teks biasa je</code><br>
    üñºÔ∏è Gambar: <code>![gambar](assets/img/nama.jpg)</code><br>
    üîó Link: <code>[teks](https://url.com)</code><br>
    üí° <i>Contoh:</i><br>
    <code># Tajuk</code><br>
    <code>Ini contoh ayat.</code><br>
    <code>![gambar](assets/img/sample1.jpg)</code>
  </div>

  <label>üñº Upload Gambar:</label>
  <input type="file" id="imageInput" accept="image/*" />
  <button id="uploadImageBtn">Upload Image</button>
  <div id="uploadStatus" style="margin-top:8px; font-size:14px; color:#0f0;"></div>

  <button id="saveBtn">üíæ Save / Update Post</button>

  <h2>üìÅ Senarai Post</h2>
  <div class="file-list" id="fileList">Loading...</div>

  <script>
    const username = "fyrus7";
    const repo = "blog";
    const branch = "main";

    // ‚úÖ Markdown ke HTML Converter ringkas
    function markdownToHTML(md) {
      return md
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/gim, '<img src="$2" alt="$1" style="max-width:100%;border-radius:8px;margin:10px 0;">')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>')
        .replace(/\n{2,}/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^(?!<h\d|<img|<a|<\/p>)([^\n<]+)$/gm, '<p>$1</p>');
    }

    async function listFiles() {
      const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/posts`);
      const files = await res.json();
      const list = document.getElementById('fileList');
      list.innerHTML = "";
      files
        .filter(f => f.name.endsWith(".html"))
        .forEach(f => {
          const item = document.createElement('div');
          item.className = 'file-item';
          item.innerHTML = `
            <span>${f.name}</span>
            <div>
              <button onclick="editFile('${f.name}')">‚úèÔ∏è Edit</button>
              <button onclick="deleteFile('${f.name}')">üßπ Delete</button>
            </div>`;
          list.appendChild(item);
        });
    }

    async function uploadImage() {
      const token = document.getElementById('token').value.trim();
      const fileInput = document.getElementById('imageInput');
      const status = document.getElementById('uploadStatus');
      const file = fileInput.files[0];
      if (!file) return alert("Sila pilih gambar dulu!");
      if (!token) return alert("Masukkan token dulu!");

      const path = `assets/img/${file.name}`;
      const reader = new FileReader();
      reader.onload = async function() {
        const base64Content = reader.result.split(',')[1];
        const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `Upload image ${file.name}`,
            content: base64Content,
            branch
          })
        });
        if (res.ok) {
          status.style.color = "#0f0";
          status.textContent = `‚úÖ ${file.name} berjaya upload!`;
          // üí° Auto insert image markdown ke textarea
          const textarea = document.getElementById('content');
          textarea.value += `\n\n![gambar](assets/img/${file.name})\n`;
        } else {
          status.style.color = "#f00";
          status.textContent = "‚ùå Gagal upload!";
        }
      };
      reader.readAsDataURL(file);
    }

    async function saveFile() {
      const token = document.getElementById('token').value.trim();
      const filename = document.getElementById('filename').value.trim();
      const mdContent = document.getElementById('content').value;
      if (!token || !filename) return alert("Isi token dan nama fail!");

      const htmlBody = markdownToHTML(mdContent);
      const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${(mdContent.match(/^# (.*)$/m) || ["", filename])[1]}</title>
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
  ${htmlBody}
</body>
</html>`;

      const path = `posts/${filename}`;
      const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;

      let sha = null;
      const check = await fetch(url);
      if (check.ok) {
        const data = await check.json();
        sha = data.sha;
      }

      const base64Content = btoa(unescape(encodeURIComponent(fullHTML)));

      const res = await fetch(url, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: sha ? `Update ${filename}` : `Create ${filename}`,
          content: base64Content,
          branch,
          sha
        })
      });

      if (res.ok) {
        alert("‚úÖ Post berjaya disimpan!");
        listFiles();
      } else {
        alert("‚ùå Gagal simpan post!");
      }
    }

    async function editFile(name) {
      const res = await fetch(`https://raw.githubusercontent.com/${username}/${repo}/${branch}/posts/${name}`);
      const text = await res.text();
      // convert balik HTML ke Markdown basic
      const md = text
        .replace(/<h1>(.*?)<\/h1>/g, '# $1')
        .replace(/<h2>(.*?)<\/h2>/g, '## $1')
        .replace(/<p>(.*?)<\/p>/g, '$1')
        .replace(/<br\s*\/?>/g, '\n')
        .replace(/<img[^>]+src="([^"]+)"[^>]*>/g, '![gambar]($1)')
        .replace(/<a[^>]+href="([^"]+)"[^>]*>(.*?)<\/a>/g, '[$2]($1)')
        .replace(/<\/?[^>]+(>|$)/g, "");
      document.getElementById('filename').value = name;
      document.getElementById('content').value = md.trim();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function deleteFile(name) {
      const token = document.getElementById('token').value.trim();
      if (!token) return alert("Isi token dulu!");
      if (!confirm(`Padam ${name}?`)) return;

      const path = `posts/${name}`;
      const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
      const get = await fetch(url);
      const data = await get.json();
      const sha = data.sha;

      const res = await fetch(url, {
        method: "DELETE",
        headers: { "Authorization": `token ${token}` },
        body: JSON.stringify({ message: `Delete ${name}`, sha, branch })
      });

      if (res.ok) {
        alert("üßπ Post dipadam!");
        listFiles();
      } else {
        alert("‚ùå Gagal padam!");
      }
    }

    document.getElementById('saveBtn').addEventListener('click', saveFile);
    document.getElementById('uploadImageBtn').addEventListener('click', uploadImage);

    listFiles();
  </script>
</body>
</html>
